name: Auto Update From ZIP

on:
  push:
    paths:
      - "updates/*.zip"

jobs:
  update-site:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install unzip
      run: sudo apt-get install unzip -y

    - name: Extract ZIP
      run: |
        ZIP_FILE=$(ls -t updates/*.zip | head -n 1)
        echo "Using ZIP: $ZIP_FILE"
        rm -rf site_tmp
        mkdir site_tmp
        unzip "$ZIP_FILE" -d site_tmp
        echo "--- Extracted ZIP structure: ---"
        ls -R site_tmp

    - name: Detect correct root folder
      id: findroot
      run: |
        # Case 1: index.html at top level
        if [ -f "site_tmp/index.html" ]; then
          echo "root=site_tmp" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Case 2: find folder that contains index.html
        ROOT=$(find site_tmp -type f -name "index.html" -printf "%h\n" | head -n 1)

        if [ -z "$ROOT" ]; then
          echo "ERROR: Could not find index.html inside ZIP!"
          exit 1
        fi

        echo "Detected root folder: $ROOT"
        echo "root=$ROOT" >> $GITHUB_OUTPUT

    - name: Replace website files
      run: |
        ROOT="${{ steps.findroot.outputs.root }}"
        echo "Using ROOT = $ROOT"

        # Delete all files except .github + updates
        find . -maxdepth 1 ! -name ".github" ! -name "updates" ! -name "." -exec rm -rf {} \;

        # Move all extracted files
        mv "$ROOT"/* .

    - name: Commit & Push
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"

        git add .
        git commit -m "Auto update from ZIP" || echo "No changes"
        git push
